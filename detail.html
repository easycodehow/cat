<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 상세 - 나이스 캣치</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js" defer></script>
    <script src="js/auth.js" defer></script>
    <script src="js/board.js" defer></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <!-- Top Banner -->
        <div class="top-banner">
            <div class="container">
                <p>무료 배송 받는 가장 쉬운 방법!</p>
            </div>
        </div>

        <!-- Main Header -->
        <div class="header-main">
            <div class="container">
                <div class="header-logo">
                    <a href="index.html">
                        <img src="images/logo_ko.png" alt="나이스 캣치">
                    </a>
                </div>

                <div class="header-search">
                    <input type="text" placeholder="어떤 상품을 찾으세요?" class="search-input">
                    <button class="search-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </button>
                </div>

                <div class="header-icons">
                    <a href="#" class="icon-btn" title="검색">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </a>
                    <a href="#" class="icon-btn" title="찜하기">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                    </a>
                    <a href="login.html" class="icon-btn" title="로그인">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </a>
                    <a href="#" class="icon-btn" title="장바구니">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <circle cx="9" cy="21" r="1"></circle>
                            <circle cx="20" cy="21" r="1"></circle>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                        </svg>
                    </a>
                </div>
            </div>
        </div>

        <!-- Navigation Menu -->
        <nav class="header-nav">
            <div class="container">
                <a href="index.html" class="nav-item">카테고리</a>
                <a href="#" class="nav-item">동물</a>
                <a href="#" class="nav-item">산업별</a>
                <a href="#" class="nav-item">병원</a>
                <a href="#" class="nav-item">이벤트</a>
                <a href="board.html" class="nav-item active">집사 커뮤니티</a>
            </div>
        </nav>
    </header>

    <!-- Post Detail Section -->
    <section class="board-section">
        <div class="container">
            <h1 class="board-main-title">게시글 상세</h1>

            <div id="postDetail" class="post-detail-container">
                <p class="loading-message">게시글을 불러오는 중...</p>
            </div>

            <div class="post-actions">
                <a href="board.html" class="btn-back">목록</a>
                <div id="postButtons"></div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-top">
                <div class="footer-logo">
                    <img src="images/logo_ko.png" alt="나이스 캣치">
                </div>
                <div class="footer-links">
                    <a href="#" class="footer-link">회사소개</a>
                    <a href="#" class="footer-link">이용약관</a>
                    <a href="#" class="footer-link">개인정보처리방침</a>
                    <a href="#" class="footer-link">고객센터</a>
                </div>
            </div>
            <div class="footer-info">
                <p>상호: 나이스 캣치 | 대표: 홍길동 | 사업자등록번호: 123-45-67890</p>
                <p>주소: 서울특별시 강남구 테헤란로 123 나이스타워 10층</p>
                <p>고객센터: 1588-1234 | 이메일: support@nicecat.com</p>
                <p class="footer-copyright">Copyright © 2025 NICE CATCH. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // URL에서 게시글 ID 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');

        // 게시글 상세 정보 불러오기
        async function loadPostDetail() {
            if (!postId) {
                document.getElementById('postDetail').innerHTML = '<p class="error-message">게시글을 찾을 수 없습니다.</p>';
                return;
            }

            try {
                const { data: post, error } = await supabase
                    .from('posts')
                    .select('*')
                    .eq('id', postId)
                    .single();

                if (error) throw error;

                if (!post) {
                    document.getElementById('postDetail').innerHTML = '<p class="error-message">게시글을 찾을 수 없습니다.</p>';
                    return;
                }

                // 조회수 증가 (세션당 한 번만)
                const updatedViews = await incrementViewCount(postId);

                // 업데이트된 조회수로 게시글 정보 갱신
                if (updatedViews !== null) {
                    post.views = updatedViews;
                }

                displayPostDetail(post);
                await loadPostButtons(post);
            } catch (error) {
                console.error('Error loading post:', error);
                document.getElementById('postDetail').innerHTML = '<p class="error-message">게시글을 불러오는데 실패했습니다.</p>';
            }
        }

        // 조회수 증가 함수
        async function incrementViewCount(postId) {
            const viewKey = `post_view_${postId}`;

            try {
                // 이미 조회한 게시글인지 확인 (세션 내에서)
                if (sessionStorage.getItem(viewKey)) {
                    // 이미 조회한 경우 현재 조회수만 가져오기
                    const { data: currentPost, error } = await supabase
                        .from('posts')
                        .select('views')
                        .eq('id', postId)
                        .single();

                    return currentPost?.views || 0;
                }

                // Supabase RPC 함수를 사용하여 조회수 증가
                const { data: newViews, error } = await supabase
                    .rpc('increment_post_views', { post_id: postId });

                if (error) {
                    console.error('Error incrementing views:', error);
                    // 에러 발생 시 현재 조회수 반환
                    const { data: currentPost } = await supabase
                        .from('posts')
                        .select('views')
                        .eq('id', postId)
                        .single();
                    return currentPost?.views || 0;
                }

                // 세션에 조회 기록 저장
                sessionStorage.setItem(viewKey, 'true');

                return newViews;
            } catch (error) {
                console.error('Error incrementing views:', error);
                return 0;
            }
        }

        // 게시글 상세 정보 표시
        function displayPostDetail(post) {
            const authorId = post.author_email ? post.author_email.split('@')[0] : '-';
            const views = post.views || 0;
            const detailHTML = `
                <div class="post-header">
                    <h2 class="post-title">${escapeHtml(post.title)}</h2>
                    <div class="post-meta">
                        <span class="post-author">작성자: ${escapeHtml(authorId)}</span>
                        <span class="post-date">작성일: ${formatDate(post.created_at)}</span>
                        <span class="post-views">조회수: ${views}</span>
                    </div>
                </div>
                <div class="post-content">
                    ${escapeHtml(post.content).replace(/\n/g, '<br>')}
                </div>
            `;
            document.getElementById('postDetail').innerHTML = detailHTML;
        }

        // 게시글 버튼 표시 (수정/삭제)
        async function loadPostButtons(post) {
            const user = await getCurrentUser();
            const buttonsContainer = document.getElementById('postButtons');

            if (user && user.id === post.user_id) {
                buttonsContainer.innerHTML = `
                    <button onclick="handleEdit()" class="btn-edit">수정</button>
                    <button onclick="handleDelete()" class="btn-delete">삭제</button>
                `;
            }
        }

        // 수정 버튼 클릭
        function handleEdit() {
            // 수정 페이지로 이동 (추후 구현)
            alert('수정 기능은 추후 구현 예정입니다.');
        }

        // 삭제 버튼 클릭
        async function handleDelete() {
            if (!confirm('정말 삭제하시겠습니까?')) {
                return;
            }

            const result = await deletePost(postId);
            if (result.success) {
                alert('게시글이 삭제되었습니다.');
                window.location.href = 'board.html';
            } else {
                alert('삭제 실패: ' + result.error);
            }
        }

        // 페이지 로드 시 실행
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadPostDetail);
        } else {
            loadPostDetail();
        }
    </script>
</body>
</html>
